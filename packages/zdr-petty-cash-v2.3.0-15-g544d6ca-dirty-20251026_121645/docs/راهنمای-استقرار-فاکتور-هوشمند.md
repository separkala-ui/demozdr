# راهنمای استقرار فاکتور هوشمند مبتنی بر Gemini

این سند آخرین نسخه فرایند «تکمیل هوشمند فاکتور» را پوشش می‌دهد. از آن‌جایی که پردازش OCR و تحلیل ساختار به‌طور کامل به سرویس Gemini منتقل شده است، دیگر نیازی به نصب سرویس پایتونی جداگانه نیست. تمام منطق درون برنامهٔ Laravel اجرا می‌شود.

---

## ۱. پیش‌نیازهای سرور

- Ubuntu 22.04 LTS (یا توزیع معادل)
- PHP 8.2 به همراه افزونه‌های `pdo_mysql`, `mbstring`, `bcmath`, `intl`, `gd`, `zip`
- Composer 2.x
- Node.js 18.x (در صورت build یا توسعه فرانت‌اند)
- پایگاه‌داده MySQL 8 یا PostgreSQL 14 (اختیاری بر اساس پروژه)

کتابخانه‌های زیر برای کارکرد هسته لاراول کافی هستند:

```bash
sudo apt update && sudo apt install -y nginx mysql-server php8.2-fpm php8.2-cli \
    php8.2-bcmath php8.2-gd php8.2-intl php8.2-mbstring php8.2-xml php8.2-zip \
    composer nodejs npm
```

---

## ۲. راه‌اندازی پروژه

1. **کلون پروژه** به مسیر دلخواه (`/var/www/zdr`).
2. **نصب وابستگی‌ها**:
   ```bash
   composer install --no-dev --optimize-autoloader
   npm ci --omit=dev
   npm run build
   ```
3. **پیکربندی محیط** (`.env`):
   ```dotenv
   APP_ENV=production
   APP_DEBUG=false
   APP_URL=https://example.com

   SMART_INVOICE_GEMINI_ENABLED=true
   SMART_INVOICE_GEMINI_API_KEY="your-google-ai-key"
   SMART_INVOICE_GEMINI_MODEL=gemini-2.5-flash
   SMART_INVOICE_GEMINI_TIMEOUT=45
   SMART_INVOICE_CONFIDENCE_THRESHOLD=0.6
   SMART_INVOICE_VALIDATION_TOLERANCE=1000
   SMART_INVOICE_ANALYTICS=true
   ```
   - `SMART_INVOICE_CONFIDENCE_THRESHOLD` مقدار حداقلی است که اگر ضریب اطمینان مدل پایین‌تر از آن باشد پیغام هشدار نمایش داده می‌شود.
   - `SMART_INVOICE_VALIDATION_TOLERANCE` بیشینه اختلاف مجاز بین جمع اقلام و جمع سطر فاکتور (به ریال) است.
4. **اجرای migrate و cache**:
   ```bash
   php artisan migrate --force
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

---

## ۳. تهیه کلید Gemini

1. وارد [Google AI Studio](https://makersuite.google.com/app/apikey) شوید و یک API Key ایجاد کنید.
2. کلید را در بخش تنظیمات بک‌اند یا فایل `.env` قرار دهید.
3. در صورت نیاز به مدل متفاوت (مثلا `gemini-1.5-pro`) مقدار `SMART_INVOICE_GEMINI_MODEL` را تغییر دهید. توصیه می‌شود پیش از تغییر مدل، با تیم محصول یا کیفیت هماهنگ شود.

> **نکته امنیتی:** این کلید را در هیچ محیطی (log, git, issue tracker) منتشر نکنید و در صورت افشا فوراً revoke کنید.

---

## ۴. فعال‌سازی از داخل برنامه

پس از ورود به پنل ادمین مسیر زیر را باز کنید:

`تنظیمات → فاکتور هوشمند`

در این صفحه می‌توانید موارد زیر را تنظیم کنید:

- کلید API و وضعیت فعال‌سازی
- نام مدل Gemini
- حداکثر زمان پاسخ (Timeout)
- آستانه اطمینان برای هشدار
- آستانه اختلاف مجاز بین مجموع اقلام و مبلغ نهایی

ذخیره تنظیمات باعث ثبت مقادیر در `settings` و به‌روزرسانی لحظه‌ای `config('smart-invoice.*')` می‌شود. پس از ذخیره موفق، پیام «تنظیمات جمینای با موفقیت ذخیره شد» نمایش داده خواهد شد.

---

## ۵. ساختار داخلی و لاگ‌ها

- کلاس `App\Services\PettyCash\SmartInvoiceService` مسئول ارسال تصویر به Gemini، دریافت خروجی و اعتبارسنجی است.
- در صورت بروز خطاهای سرویس یا JSON ناقص، فایل خام در مسیر `storage/logs/smart-invoice/*.txt` ذخیره می‌شود.
- هشدارهای مربوط به اختلاف مبالغ، در UI به همراه آستانه مجاز نشان داده می‌شوند تا کاربر تصمیم بگیرد داده اصلاح شود یا خیر.

برای پایش سرویس، لاگ‌های Laravel (`storage/logs/laravel.log`) کفایت می‌کند. هیچ پردازش جداگانه‌ای در background یا worker اضافه نشده است.

---

## ۶. پرسش‌های متداول

### خطای «سرویس هوشمند فاکتور فعال نیست» نمایش داده می‌شود
- مقدار `SMART_INVOICE_GEMINI_ENABLED` را بررسی کنید.
- از ثبت کلید API در تنظیمات مطمئن شوید.
- پس از تغییرات، فرمان `php artisan config:clear` را اجرا کنید.

### چرا خروجی اعداد اشتباه است؟
- تنظیم `SMART_INVOICE_VALIDATION_TOLERANCE` را کاهش دهید تا اختلاف‌ها به سرعت مشخص شوند.
- تصاویر با کیفیت پایین (اسکن شده یا زاویه‌دار) دقت مدل را کم می‌کند؛ توصیه می‌شود عکس واضح و بدون برش استفاده شود.

### آیا همچنان می‌توان از سرویس قبلی استفاده کرد؟
خیر؛ کدهای مربوط به میکروسرویس پایتون حذف شده و تنها مسیر رسمی، استفاده از Gemini است. در صورت نیاز به جایگزین آفلاین باید ماژول مجزا توسعه یابد.

---

## ۷. به‌روزرسانی نسخه

1. `git pull` یا استقرار نسخه جدید.
2. اجرای `composer install --no-dev --optimize-autoloader`.
3. اجرای `php artisan migrate --force` در صورت وجود مهاجرت جدید.
4. پاک‌سازی cache ها (`php artisan config:cache` و غیره).
5. بررسی health برنامه با فراخوانی صفحه‌ی فرم تنخواه و تست یک فاکتور نمونه.

---

با انجام مراحل بالا فاکتور هوشمند بدون نیاز به وابستگی‌های جانبی و تنها با تکیه بر Gemini آمادهٔ استفاده خواهد بود.
