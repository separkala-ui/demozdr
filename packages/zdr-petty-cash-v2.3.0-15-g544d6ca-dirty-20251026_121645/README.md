# ZDR – ماژول تنخواه (Tankha / Petty Cash)

این مخزن نسخهٔ آمادهٔ نصب ماژول «تنخواه» ZDR است؛ می‌توانید آن را به صورت مستقل اجرا کنید یا در پروژهٔ لاراول موجودتان ادغام نمایید. README حاضر به گونه‌ای نوشته شده که هر توسعه‌دهنده (یا حتی ابزارهای خودکاری مانند Cursor) بتواند بدون سردرگمی پروژه را نصب و راه‌اندازی کند.

---

## فهرست مطالب

1. [پیش‌نیازهای سخت‌افزاری و نرم‌افزاری](#پیشنیازهای-سختافزاری-و-نرم‌افزاری)
2. [نصب سریع (روش پیشنهادی)](#نصب-سریع-روش-پیشنهادی)
3. [نصب دستی گام‌به‌گام](#نصب-دستی-گامبهگام)
4. [ساختار پوشه‌ها و فایل‌های مهم](#ساختار-پوشهها-و-فایلهای-مهم)
5. [ادغام در پروژه‌های دیگر](#ادغام-در-پروژههای-دیگر)
6. [نکات عملیاتی و تنظیمات تکمیلی](#نکات-عملیاتی-و-تنظیمات-تکمیلی)
7. [پشتیبانی و مشارکت](#پشتیبانی-و-مشارکت)

---

## پیش‌نیازهای سخت‌افزاری و نرم‌افزاری

| مؤلفه | نسخهٔ پیشنهادی | توضیحات |
| --- | --- | --- |
| سیستم‌عامل | Ubuntu 22.04 / Debian 12 / macOS 14 / Windows 10+ (WSL توصیه می‌شود) | هر سیستم‌عامل مبتنی بر POSIX که bash را در اختیار بگذارد قابل استفاده است. |
| PHP | 8.2 یا بالاتر | باید افزونه‌های `bcmath`, `curl`, `dom`, `fileinfo`, `gd`, `intl`, `mbstring`, `openssl`, `pdo_mysql`, `tokenizer`, `xml` فعال باشند. |
| Composer | نسخهٔ 2 (حداقل 2.6) | برای نصب وابستگی‌های PHP. |
| Node.js | 18 LTS یا بالاتر | همراه با npm 9+. |
| Database | MySQL 8 / MariaDB 10.6 به بالا | می‌توانید از سایر درایورها (PostgreSQL و …) استفاده کنید اما باید config را مطابق آن اصلاح کنید. |
| وب سرور | Nginx یا Apache | برای محیط توسعه می‌توانید از `php artisan serve` استفاده کنید. |
| ابزارهای عمومی | git, bash, unzip/zip, supervisor (برای queue در محیط production) | نصب آن‌ها بسته به سیستم‌عامل متفاوت است. |

> **توصیه:** اگر قصد دارید پروژه را برای اولین‌بار روی Windows اجرا کنید، از WSL2 (Ubuntu) استفاده کنید تا با مشکلات مسیر و مجوزها روبه‌رو نشوید.

---

## نصب سریع (روش پیشنهادی)

ساده‌ترین راه استفاده از اسکریپت آماده‌ی `scripts/install.sh` است که تمام مراحل زیر را انجام می‌دهد:

1. کپی کردن `.env.example` به `.env`
2. اجرای `composer install`
3. تولید `APP_KEY`
4. پاک کردن کش‌های لاراول
5. اجرای `php artisan migrate`
6. اجرای `php artisan db:seed` (در صورت استفاده از گزینهٔ `--seed`)
7. ساخت لینک `storage:link`
8. نصب وابستگی‌های فرانت‌اند و بیلد فایل‌ها (`npm install` + `npm run build`)

**دستور:**

```bash
git clone https://github.com/separkala-ui/zdr.git
cd zdr
./scripts/install.sh --seed
```

گزینه‌ها:

| گزینه | توضیح |
| --- | --- |
| `--seed` | اجرای Seederهای دیتابیس (اختیاری) |
| `--no-build` | نصب بدون اجرای npm (مفید برای سرورهای بدون Node.js) |
| `--help` | نمایش راهنما |

> پس از اجرای اسکریپت، فایل `.env` ساخته می‌شود. حتماً مقادیر اتصال به دیتابیس، کلیدهای API (مانند Gemini یا OCR)، URL پروژه و … را مطابق نیاز خود تنظیم کنید.

### راه‌اندازی سریع پس از نصب

```bash
# راه‌اندازی سرور توسعه
php artisan serve --host=0.0.0.0 --port=8000

# اجرای queue worker (در صورت نیاز)
php artisan queue:work
```

مسیر پیش‌فرض پنل مدیریتی: `http://localhost:8000/admin`

---

## نصب دستی (گام‌به‌گام)

اگر نمی‌خواهید از اسکریپت استفاده کنید، مراحل را به صورت دستی اجرا کنید:

1. **کلون کردن مخزن**
   ```bash
   git clone https://github.com/separkala-ui/zdr.git
   cd zdr
   ```

2. **ساخت فایل `.env`**
   ```bash
   cp .env.example .env
   ```
   - مقدارهای کلیدی را تنظیم کنید: `APP_NAME`, `APP_URL`, تنظیمات `DB_*`, تنظیمات ایمیل، کلیدهای OCR/Gemini، و هر سرویس دیگر.

3. **نصب وابستگی‌های PHP**
   ```bash
   composer install --no-interaction --prefer-dist
   ```

4. **تولید کلید برنامه**
   ```bash
   php artisan key:generate
   ```

5. **اجرای مهاجرت‌ها و (در صورت نیاز) Seederها**
   ```bash
   php artisan migrate
   php artisan db:seed # در صورت نیاز
   ```

6. **ساخت لینک storage**
   ```bash
   php artisan storage:link
   ```

7. **نصب وابستگی‌های فرانت‌اند و بیلد**
   ```bash
   npm install
   npm run build
   ```

8. **پاکسازی کش‌ها**
   ```bash
   php artisan optimize:clear
   ```

9. **راه‌اندازی سرویس‌ها**
   - اجرای سرور داخلی لاراول: `php artisan serve`
   - راه‌اندازی queue worker (برای ارسال اعلان‌ها و پردازش فاکتور): `php artisan queue:work`
   - پیکربندی scheduler (مثل cronjob برای `php artisan schedule:run`)

---

## ساختار پوشه‌ها و فایل‌های مهم

- `app/Console/Commands` : دستور آرشیو‌گیری تنخواه.
- `app/Http/Controllers/Backend` : کنترلرهای تنخواه و تنظیمات هوش‌مصنوعی فاکتور هوشمند.
- `app/Livewire/PettyCash` : کامپوننت‌های Livewire مربوط به فرم‌ها و جدول تراکنش‌ها.
- `app/Models` : مدل‌های دیتابیس تنخواه.
- `app/Services/PettyCash` : سرویس‌های دامنه‌ای (شارژ، تسویه، پردازش فاکتور، Gemini و ...) به همراه سرویس‌های جانبی مورد نیاز.
- `config/smart-invoice.php` و `resources/lang/fa/smart_invoice.php` : تنظیمات و ترجمه‌های مرتبط با فاکتورهای هوشمند.
- `database/migrations` : مایگریشن‌های جدول‌های تنخواه.
- `resources/views/backend/pages/petty-cash` و `resources/views/livewire/petty-cash` : صفحات Blade و ویوهای Livewire.
- `routes/petty-cash.php` : مجموعه‌ی مسیرهای پیشنهادی که باید داخل گروه ادمین پروژه‌تان اضافه کنید.
- `docs/smart-invoice-architecture.md` : توضیح معماری سرویس‌های OCR و خط لوله‌ی پردازش.
- `docs/راهنمای-نصب-سریع.md` : نسخهٔ فارسی و مفصل راهنمای نصب.

---

## ادغام در پروژه‌های دیگر
در صورتی که قصد دارید ماژول تنخواه را در پروژه‌ی لاراول دیگر ادغام کنید:

1. **انتقال فایل‌ها**: پوشه‌های موجود در این ریپو را به مسیر متناظر خود در پروژهٔ مقصد منتقل کنید.
2. **افزودن مسیرها**: محتوای `routes/petty-cash.php` را داخل گروه روتر ادمین (`Route::prefix('admin')->middleware('auth')`) قرار دهید.
3. **ثبت کامندها**: `App\Console\Commands\PettyCashArchive` را در `app/Console/Kernel.php` ثبت و زمان‌بندی کنید.
4. **مجوزها و نقش‌ها**: با سرویس‌های مربوط به نقش/مجوز (یا هر سیستم ACL موجود) سطح دسترسی‌های `petty_cash.*` را به نقش‌های مناسب اختصاص دهید.
5. **تنظیمات و ترجمه‌ها**: فایل‌های تنظیمات و ترجمه را merge کرده و مقادیر `.env` مرتبط با OCR و Gemini را تنظیم کنید.
6. **وابستگی‌های فرانت‌اند**: اگر از ماژول‌های اضافی (مانند `modules/jalaali-js-master`) استفاده می‌کنید، آن‌ها را به pipeline Vite اضافه کنید.
7. **تست عملیاتی**: پس از ادغام، تمام سناریوهای اصلی (ثبت دفتر، ثبت تراکنش، تایید/رد، تسویه و گزارش‌گیری) را در محیط staging تست کنید.

---

## نکات عملیاتی و تنظیمات تکمیلی

- **Queue و Scheduler**: پردازش‌های OCR و ارسال اعلان‌ها در صف اجرا می‌شوند؛ در محیط production حتماً worker دائمی (مثل Supervisor) و job زمان‌بندی (`php artisan schedule:run`) را پیکربندی کنید.
- **اطمینان از تنظیمات جلالی**: فایل `modules/jalaali-js-master` در باندل در نظر گرفته شده است؛ در صورت تغییر build pipeline باید import آن را لحاظ کنید.
- **SSL/Reverse Proxy**: اگر پشت reverse proxy هستید حتماً `APP_URL` صحیح و هدرهای `TrustedProxies` را پیکربندی کنید.
- **Storage**: آپلودها در `storage/app/public` ذخیره و از طریق `public/storage` سرو می‌شوند؛ حتماً دسترسی پوشه‌ها را تنظیم کنید (`chmod -R 775 storage bootstrap/cache`).
- **Log و مانیتورینگ**: لاراول لاگ‌ها را در `storage/logs` نگه می‌دارد؛ برای production پیشنهاد می‌شود از ابزارهای جمع‌آوری لاگ (ELK، Sentry، …) استفاده کنید.

---

## پشتیبانی و مشارکت

- برای گزارش باگ‌ها یا پیشنهاد ویژگی جدید، لطفاً Issue ایجاد کنید.
- پیش از ارسال Pull Request حتماً:
  - تست‌ها و lint را اجرا کنید (`npm run lint`, `composer test` در صورت موجود بودن).
  - تغییرات اسناد را به‌روز نگه دارید.
  - توضیحات کامل و سناریوی تست را در PR بنویسید.

با مشارکت شما می‌توانیم ماژول تنخواه ZDR را برای همه توسعه‌دهندگان قابل اتکا و ساده کنیم. سپاس از همراهی شما 🙏

## محتویات
- `app/Console/Commands` : دستور آرشیو‌گیری تنخواه.
- `app/Http/Controllers/Backend` : کنترلرهای تنخواه و تنظیمات هوش‌مصنوعی فاکتور هوشمند.
- `app/Livewire/PettyCash` : کامپوننت‌های Livewire مربوط به فرم‌ها و جدول تراکنش‌ها.
- `app/Models` : مدل‌های دیتابیس تنخواه.
- `app/Services/PettyCash` : سرویس‌های دامنه‌ای (شارژ، تسویه، پردازش فاکتور، Gemini و ...) به همراه سرویس‌های جانبی مورد نیاز.
- `config/smart-invoice.php` و `resources/lang/fa/smart_invoice.php` : تنظیمات و ترجمه‌های مرتبط با فاکتورهای هوشمند.
- `database/migrations` : مایگریشن‌های جدول‌های تنخواه.
- `resources/views/backend/pages/petty-cash` و `resources/views/livewire/petty-cash` : صفحات Blade و ویوهای Livewire.
- `routes/petty-cash.php` : مجموعه‌ی مسیرهای پیشنهادی که باید داخل گروه ادمین پروژه‌تان اضافه کنید.
- `docs/smart-invoice-architecture.md` : توضیح معماری سرویس‌های OCR و خط لوله‌ی پردازش.

## نحوه‌ی ادغام در پروژه‌ی اصلی
1. **کپی فایل‌ها**: پوشه‌ها و فایل‌های این ریپو را به مسیر متناظرشان در اپلیکیشن لاراول مقصد منتقل کنید.
2. **مسیرها**: محتوای `routes/petty-cash.php` را داخل گروه روتر ادمین خود `Route::prefix('admin')->middleware('auth')` اضافه کنید.
3. **کامند شل**: کلاس `App\Console\Commands\PettyCashArchive` را در `app/Console/Kernel.php` به آرایه‌ی `$commands` اضافه کنید و در صورت نیاز زمان‌بندی (`schedule`) تنظیم کنید.
4. **دسترسی‌ها**: با استفاده از `RolesService` و `PermissionService` سطح دسترسی‌های `petty_cash.*` را به نقش‌های مناسب اضافه کنید.
5. **ترجمه و تنظیمات**: فایل‌های ترجمه و `config/smart-invoice.php` را publish یا merge کنید، سپس مقادیر .env مثل کلیدهای Gemini/OCR را تکمیل کنید.
6. **فرانت‌اند**: اگر از تاریخ‌شمار جلالی یا اسکریپت‌های تکمیلی استفاده می‌کنید، ایمپورت‌های لازم (مثل `modules/jalaali-js-master`) را به باندل Vite/webpack اضافه نمایید.
7. **تست‌ها یا سیلودا**: پس از ادغام، `php artisan migrate` و سناریوهای اصلی (ثبت/ویرایش دفتر، ثبت تراکنش، تسویه، تولید گزارش) را تست کنید.

## وضعیت انتشار
این ماژول به صورت بسته‌ی Composer آماده نشده است و ساختار آن یک «overlay» است تا بتوانید سریعاً در پروژه‌ی موجودتان merge کنید. در صورت نیاز می‌توانید با تغییر namespaceها به `Separkala\Tankha\...` و تنظیم `composer.json` آن را به یک پکیج مستقل تبدیل کنید.

در صورت بروز مشکل یا نیاز به مستندسازی بیشتر، Issue باز کنید.

## نصب سریع در محیط تازه

اگر می‌خواهید کل پروژه‌ی تنخواه را مستقل اجرا کنید، اسکریپت نصب خودکار فراهم شده است:

```bash
git clone https://github.com/<ORGANIZATION>/<REPO>.git zdr
cd zdr
./scripts/install.sh --seed
```

نکات و گزینه‌های بیشتر (مانند اجرای بدون بیلد فرانت‌اند) در سند [docs/راهنمای-نصب-سریع.md](docs/راهنمای-نصب-سریع.md) توضیح داده شده است.
