# راهنمای استقرار و پشتیبانی فاکتور هوشمند (پیشرفته)

این سند برای تیم‌های فنی نوشته شده تا بتوانند افزونهٔ «فاکتور هوشمند تنخواه» را روی هر سروری نصب، نگهداری و در صورت نیاز بازیابی کنند. تمام مراحل به صورت گام‌به‌گام و با ذکر فرمان‌ها آورده شده است.

---

## ۱. پیش‌نیازهای نرم‌افزاری سرور

- **سیستم‌عامل پیشنهادی:** Ubuntu 22.04 LTS یا هر توزیع لینوکسی معادل.
- **وب‌سرور:** Nginx یا Apache (مثال‌ها بر اساس Nginx نوشته شده است).
- **نسخه‌ها:**
  - PHP 8.2 به همراه افزونه‌های `pdo_mysql`, `mbstring`, `bcmath`, `intl`, `gd`, `zip`.
  - Composer 2.x
  - Node.js 18.x (در صورت نیاز به build فرانت‌اند)
  - Python 3.10+
  - MySQL 8 یا PostgreSQL 14 (به انتخاب شما)
- **کتابخانه‌های سیستمی برای OCR:** `ffmpeg`, `libsm6`, `libxext6`

```bash
sudo apt update && sudo apt install -y nginx mysql-server php8.2-fpm php8.2-cli \
    php8.2-bcmath php8.2-gd php8.2-intl php8.2-mbstring php8.2-xml php8.2-zip \
    composer nodejs npm python3 python3-venv ffmpeg libsm6 libxext6
```

---

## ۲. نصب یا انتقال پروژه به سرور تازه

1. **ساخت مسیر پروژه:**
   ```bash
   sudo mkdir -p /var/www/zdr
   sudo chown -R $USER:$USER /var/www/zdr
   ```
2. **انتقال سورس:**
   - روش Git:
     ```bash
     cd /var/www
     git clone git@your-repo.git zdr
     cd zdr
     git checkout main
     ```
   - روش آرشیو: فایل zip/tar را به `/var/www` منتقل و استخراج کنید.
3. **وابستگی‌های PHP و JS:**
   ```bash
   cd /var/www/zdr
   composer install --no-dev --optimize-autoloader
   npm ci && npm run build   # در صورت نیاز
   ```
4. **تنظیم فایل محیطی:**
   ```bash
   cp .env.example .env
   php artisan key:generate
   ```
   سپس `SMART_INVOICE_SERVICE_URL`، اطلاعات پایگاه‌داده و دامنه را در `.env` و صفحهٔ تنظیمات وارد کنید.
5. **ساخت پایگاه‌داده و اجرای مایگریشن:**
   ```bash
   php artisan migrate --force
   php artisan db:seed --class=PermissionSeeder   # در صورت نیاز
   ```
6. **اعمال دسترسی‌ها:**
   ```bash
   sudo chown -R www-data:www-data storage bootstrap/cache
   sudo chmod -R 775 storage bootstrap/cache
   ```

---

## ۳. راه‌اندازی سرویس پایتون (OCR و هوش مصنوعی)

1. **ساخت محیط مجازی:**
   ```bash
   python3 -m venv /opt/pettycash-ai
   source /opt/pettycash-ai/bin/activate
   ```
2. **نصب وابستگی‌ها:**
   ```bash
   pip install -r /var/www/zdr/python/pettycash_ai/requirements.txt
   ```
3. **اجرای دستی برای تست:**
   ```bash
   uvicorn python.pettycash_ai.main:app --host 0.0.0.0 --port 8000
   ```
4. **ایجاد سرویس systemd (اختیاری):**
   ```ini
   # /etc/systemd/system/pettycash-ai.service
   [Unit]
   Description=PettyCash Smart Invoice API
   After=network.target

   [Service]
   User=www-data
   Group=www-data
   WorkingDirectory=/var/www/zdr
   Environment="PATH=/opt/pettycash-ai/bin"
   ExecStart=/opt/pettycash-ai/bin/uvicorn python.pettycash_ai.main:app --host 0.0.0.0 --port 8000
   Restart=on-failure

   [Install]
   WantedBy=multi-user.target
   ```
   سپس:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable --now pettycash-ai
   ```

---

## ۴. تنظیمات داخل داشبورد (برای سوپرادمین)

1. به مسیر **تنظیمات → فاکتور هوشمند** بروید.
2. مقدارهای زیر را وارد کنید:
   - آدرس سرویس پایتون (مثلاً `http://127.0.0.1:8000`) **توجه:** انتهای آدرس را بدون `/extract` وارد کنید؛ سامانه به‌صورت خودکار مسیر `extract/` را اضافه می‌کند.
   - زمان Timeout (پیشنهاد: ۶۰ ثانیه)
   - توکن دسترسی (در صورت نیاز)
   - فعال یا غیرفعال بودن ذخیرهٔ تحلیل‌ها
3. تغییرات را ذخیره و با دکمهٔ «تشخیص هوشمند فاکتور» یک ردیف آزمایشی ایجاد کنید.

---

## ۵. سناریوی مهاجرت به سرور جدید

1. **بک‌آپ از سرور فعلی:**
   - خروجی دیتابیس (mysqldump یا pg_dump)
   - آرشیو از پوشهٔ `storage/app` و `storage/app/public`
   - در صورت لزوم، فایل‌های کانفیگ شخصی‌سازی‌شده
2. **کپی بک‌آپ به سرور جدید** (با `scp` یا S3).
3. **طی مراحل بخش ۲ و ۳** برای آماده‌سازی سرور جدید.
4. **وارد کردن دیتابیس و فایل‌ها:**
   ```bash
   mysql -u USER -p DATABASE < backup.sql
   unzip storage-backup.zip -d /var/www/zdr/storage
   ```
5. **پاک‌سازی کش‌ها:**
   ```bash
   php artisan migrate --force
   php artisan config:clear
   php artisan cache:clear
   php artisan route:clear
   ```
6. **آزمایش نهایی** و سپس تغییر DNS یا Nginx.

---

## ۶. بازگردانی بک‌آپ مرحله‌به‌مرحله (Disaster Recovery)

1. **بررسی سلامت بک‌آپ** با تطبیق هش و تاریخ ایجاد.
2. **خاموش کردن برنامه** یا قرار دادن سایت در حالت نگهداری:
   ```bash
   php artisan down --render="errors::503"
   ```
3. **بازگردانی فایل‌ها** طبق دستورالعمل بخش ۵ (گام ۴).
4. **بازگردانی پایگاه‌داده** با فرمان‌های `mysql` یا `psql`.
5. **بازسازی کش و ایندکس‌ها:**
   ```bash
   php artisan optimize
   php artisan queue:restart   # اگر از صف استفاده می‌کنید
   ```
6. **بالا آوردن برنامه:**
   ```bash
   php artisan up
   ```
7. **کنترل کیفیت:** بررسی تراکنش‌های آخر، تست گزارش چاپی، بررسی اتصال سرویس پایتون.
8. **حذف فایل‌های موقت بک‌آپ** پس از اطمینان از موفقیت عملیات.

---

## ۷. نکات نگهداشت و مانیتورینگ

- **لاگ‌ها:** هر گونه خطای OCR یا ارتباطی در `storage/logs/laravel.log` و `/var/log/syslog` (برای systemd) ثبت می‌شود.
- **مانیتورینگ سلامت:** پیشنهاد می‌شود برای URL `/extract` یک چک رباتیک دوره‌ای (Health Check) تعریف شود.
- **به‌روزرسانی وابستگی‌ها:** به صورت دوره‌ای (مثلاً فصلی) دستور `pip install --upgrade -r requirements.txt` و `composer update` (در محیط Stage) اجرا و پس از تست به محیط اصلی منتقل شود.
- **امنیت:** در صورت انتشار سرویس پایتون روی شبکهٔ عمومی حتماً:
  - محدودسازی IP با فایروال
  - فعال‌سازی HTTPS از طریق Nginx reverse proxy
  - استفاده از توکن یا Basic Auth

---

## ۸. عیب‌یابی رایج

| پیام خطا | علت احتمالی | راه‌حل |
| --- | --- | --- |
| `EasyOCR is not installed. Please pip install easyocr or configure SMART_INVOICE_OCR_ENDPOINT.` | بستهٔ EasyOCR در محیط مجازی پایتون نصب نشده یا هنگام به‌روزرسانی پاک شده است. | وارد محیط مجازی شوید:<br>`source /opt/pettycash-ai/bin/activate`<br>سپس دستور `pip install easyocr opencv-python` را اجرا و سرویس را ری‌استارت کنید (`systemctl restart pettycash-ai` یا اجرای مجدد uvicorn). |
| `SMART_INVOICE_SERVICE_URL is not defined` | آدرس سرویس در تنظیمات ذخیره نشده است. | در داشبورد → تنظیمات → فاکتور هوشمند، مقدار URL (مثلاً `http://127.0.0.1:8000`) را ثبت و ذخیره کنید. |
| `Connection refused` یا `Failed to establish a new connection` | سرویس پایتون روشن نیست یا پورت فایروال مسدود است. | وضعیت سرویس را بررسی کنید (`systemctl status pettycash-ai`) و در صورت خاموش بودن دوباره اجرا کنید. اطمینان حاصل کنید پورت در فایروال باز باشد (`ufw allow 8000/tcp`). |
| `Request timed out after 45s` | پردازش OCR طولانی شده یا منابع سرور کافی نیست. | مقدار زمان انتظار را در تب تنظیمات روی ۶۰ یا ۹۰ ثانیه بگذارید، منابع CPU/RAM را بررسی کرده و در صورت نیاز سرویس را روی سرور قوی‌تر یا با GPU اجرا کنید. |

> پس از نصب هر پکیج جدید در محیط مجازی، uvicorn یا سرویس systemd را ری‌استارت کنید تا تغییرات اعمال شود.

---

## ۸. چک‌لیست کوتاه نصب (برای چاپ و همراه داشتن در محل)

1. آماده‌سازی پیش‌نیازهای سیستمی (PHP, Composer, Python).
2. انتقال سورس پروژه و نصب composer/npm.
3. پیکربندی `.env` و اجرای مایگریشن‌ها.
4. نصب وابستگی‌های پایتون و اجرای سرویس uvicorn.
5. ثبت آدرس سرویس در تنظیمات و تست دکمهٔ «تشخیص هوشمند فاکتور».
6. پاک‌سازی کش‌ها و مانیتورینگ لاگ‌ها.

> **یادآوری:** هر بار که تنظیمات یا سرویس پایتون تغییر می‌کند، از طریق صفحهٔ تنظیمات مقدار جدید را ذخیره کرده و یک تراکنش آزمایشی ثبت کنید تا صحت خروجی تأیید شود.

---

## ۹. راهنمای کامل نصب و راه‌اندازی (مرجع کامل)

### مرحله ۱: بررسی منابع سرور
```bash
# بررسی حافظه و فضای دیسک
free -h
df -h

# بررسی فرآیندهای حافظه‌بر
ps aux --sort=-%mem | head -10
```

**⚠️ نکته مهم:** اگر حافظه آزاد کمتر از 1GB باشد، ابتدا منابع سرور را بهینه کنید.

### مرحله ۲: نصب پیش‌نیازهای سیستم
```bash
# به‌روزرسانی سیستم
sudo apt update && sudo apt upgrade -y

# نصب پکیج‌های مورد نیاز
sudo apt install -y python3 python3-venv python3-pip ffmpeg libsm6 libxext6

# پاک‌سازی کش‌های سیستم
sudo apt clean && sudo apt autoremove -y
```

### مرحله ۳: ایجاد محیط مجازی پایتون
```bash
# ایجاد محیط مجازی
python3 -m venv /opt/pettycash-ai

# فعال‌سازی محیط مجازی
source /opt/pettycash-ai/bin/activate

# به‌روزرسانی pip
pip install --upgrade pip
```

### مرحله ۴: نصب وابستگی‌های پایتون
```bash
# نصب تمام وابستگی‌ها
cd /var/www/zdr
pip install -r python/pettycash_ai/requirements.txt --no-cache-dir

# نصب مجدد پکیج‌های مهم (در صورت نیاز)
pip install --force-reinstall Pillow opencv-python easyocr uvicorn[standard]
```

### مرحله ۵: اصلاح تنظیمات Pydantic (برای نسخه 2.x)
فایل `python/pettycash_ai/config.py` را ویرایش کنید:
```python
from pydantic_settings import BaseSettings  # تغییر از pydantic
from pydantic import field_validator        # تغییر از validator

class Settings(BaseSettings):
    # ... سایر تنظیمات
    
    @field_validator("easyocr_languages", mode="before")  # تغییر از @validator
    @classmethod
    def parse_languages(cls, value):
        if isinstance(value, str):
            return [item.strip() for item in value.split(",") if item.strip()]
        return value
```

### مرحله ۶: ایجاد سرویس systemd
فایل `/etc/systemd/system/pettycash-ai.service` را ایجاد کنید:
```ini
[Unit]
Description=PettyCash Smart Invoice API
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/var/www/zdr
Environment="PATH=/opt/pettycash-ai/bin"
ExecStart=/opt/pettycash-ai/bin/uvicorn python.pettycash_ai.main:app --host 127.0.0.1 --port 8000 --workers 1 --limit-max-requests 100
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

### مرحله ۷: راه‌اندازی سرویس
```bash
# بارگذاری تنظیمات systemd
sudo systemctl daemon-reload

# فعال‌سازی و شروع سرویس
sudo systemctl enable --now pettycash-ai

# بررسی وضعیت سرویس
sudo systemctl status pettycash-ai
```

### مرحله ۸: تست سرویس
```bash
# تست endpoint اصلی
curl -s -X POST http://127.0.0.1:8000/extract -H "Content-Type: application/json" -d '{"test": "data"}'

# تست مستندات API
curl -s http://127.0.0.1:8000/docs
```

**✅ پاسخ مورد انتظار:** `{"detail":"At least one file must be uploaded."}`

### مرحله ۹: تنظیمات Laravel Dashboard
1. وارد **Laravel Dashboard** شوید
2. به مسیر **تنظیمات → فاکتور هوشمند** بروید
3. مقادیر زیر را وارد کنید:
   - **Service base URL:** `http://127.0.0.1:8000`
   - **Service access token:** (خالی بگذارید)
   - **Timeout:** `60` ثانیه
   - **Analytics:** فعال کنید
4. **ذخیره** کنید

### مرحله ۱۰: تست نهایی
1. یک ردیف تنخواه جدید ایجاد کنید
2. روی دکمه **"تشخیص هوشمند فاکتور"** کلیک کنید
3. یک فایل تصویری فاکتور آپلود کنید
4. منتظر نتیجه پردازش باشید

---

## ۱۰. عیب‌یابی پیشرفته

### مشکل: `ModuleNotFoundError: No module named 'PIL'`
```bash
# راه‌حل
source /opt/pettycash-ai/bin/activate
pip install --force-reinstall Pillow
systemctl restart pettycash-ai
```

### مشکل: `cURL error 52: Empty reply from server`
```bash
# بررسی وضعیت سرویس
systemctl status pettycash-ai

# بررسی لاگ‌ها
journalctl -u pettycash-ai -l

# راه‌حل: ری‌استارت سرویس
systemctl restart pettycash-ai
```

### مشکل: کمبود منابع سرور
```bash
# بررسی منابع
free -h
df -h

# پاک‌سازی کش‌ها
sudo apt clean
sudo apt autoremove -y

# بهینه‌سازی تنظیمات uvicorn
# در فایل systemd service:
# --workers 1 --limit-max-requests 100
```

---

## ۱۱. دستورات مفید برای نگهداری

### بررسی وضعیت سرویس
```bash
# وضعیت کلی
systemctl status pettycash-ai

# لاگ‌های اخیر
journalctl -u pettycash-ai -l --since "1 hour ago"

# مصرف حافظه
ps aux | grep uvicorn
```

### ری‌استارت سرویس
```bash
# ری‌استارت ساده
systemctl restart pettycash-ai

# ری‌استارت با توقف کامل
systemctl stop pettycash-ai
sleep 5
systemctl start pettycash-ai
```

### به‌روزرسانی وابستگی‌ها
```bash
# فعال‌سازی محیط مجازی
source /opt/pettycash-ai/bin/activate

# به‌روزرسانی pip
pip install --upgrade pip

# به‌روزرسانی وابستگی‌ها
pip install --upgrade -r python/pettycash_ai/requirements.txt

# ری‌استارت سرویس
systemctl restart pettycash-ai
```

---

## ۱۲. چک‌لیست نهایی موفقیت

- [ ] منابع سرور کافی (حداقل 1GB RAM آزاد)
- [ ] Python 3.10+ نصب شده
- [ ] محیط مجازی `/opt/pettycash-ai` ایجاد شده
- [ ] تمام وابستگی‌های پایتون نصب شده
- [ ] تنظیمات Pydantic اصلاح شده
- [ ] سرویس systemd ایجاد و فعال شده
- [ ] سرویس در حال اجرا (`active (running)`)
- [ ] endpoint `/extract` پاسخ می‌دهد
- [ ] تنظیمات Laravel Dashboard تکمیل شده
- [ ] تست "تشخیص هوشمند فاکتور" موفق است

---

## ۱۳. نتیجه نهایی

✅ **سرویس فاکتور هوشمند با موفقیت راه‌اندازی شد!**

**آدرس سرویس:** `http://127.0.0.1:8000`
**وضعیت:** `active (running)`
**مصرف حافظه:** ~400MB (بهینه‌شده)
**پایداری:** خودکار ری‌استارت در صورت خطا

**نکات مهم:**
- سرویس فقط روی localhost در دسترس است (امن)
- تمام پردازش‌ها محلی انجام می‌شود
- لاگ‌ها در `journalctl -u pettycash-ai` قابل مشاهده است
- در صورت نیاز به دسترسی خارجی، از Nginx reverse proxy استفاده کنید

موفق باشید 🌱
