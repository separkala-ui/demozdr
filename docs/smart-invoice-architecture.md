# Smart Invoice – Gemini Architecture

این نسخه ساختار جدید تکمیل خودکار فاکتور را توضیح می‌دهد؛ تمام مراحل هوش‌مصنوعی توسط سرویس Gemini انجام می‌شود و دیگر به مایکروسرویس پایتونی نیازی نیست.

## 1. جریان کلی

1. کاربر داخل فرم تنخواه تصویر فاکتور (و در صورت نیاز رسید POS) را بارگذاری و روی دکمه «تکمیل هوشمند» کلیک می‌کند.
2. کامپوننت Livewire (`TransactionForm`) فایل‌های موقت را به `SmartInvoiceService` ارسال می‌کند.
3. سرویس PHP با توجه به تنظیمات فعال بودن Gemini و کلید API، پرامپت و داده‌های تصویری را برای مدل مشخص‌شده (`gemini-2.5-flash` به صورت پیش‌فرض) آماده می‌کند.
4. پاسخ ساخت‌یافته مدل به `SmartInvoiceExtraction` تبدیل می‌شود؛ سپس فروض محاسباتی مانند جمع اقلام، مالیات، تخفیف، هزینه حمل و پیش‌پرداخت با آستانه خطای قابل تنظیم بررسی می‌شوند.
5. مقادیر نهایی در فرم درج، وضعیت و پیام‌ها در رابط کاربری نمایش و متادیتا داخل ستون `meta->smart_invoice` ذخیره می‌شود.

```
[Livewire Form] → [SmartInvoiceService] → [Google Gemini] → [SmartInvoiceExtraction] → [Form Auto-Fill]
```

## 2. درخواست به Gemini

- تصاویر فاکتور و رسید به صورت Base64 در قالب `inline_data` ارسال می‌شود و متن پرامپت توسط `GeminiPromptBuilder` تولید می‌گردد.
- از قابلیت **function calling** استفاده می‌کنیم؛ بدین ترتیب مدل باید دقیقا طبق اسکیمای «set_invoice» پاسخ دهد.
- پارامترهای مهم:
  - `has_receipt` برای اطلاع مدل از وجود رسید و استفاده از آن به عنوان منبع کمکی.
  - `context` برای ارسال شناسه دفتر، نوع تراکنش و مبلغ فعلی فرم تا مدل پاسخ متناسب‌تری بدهد.
- تنظیمات قابل‌تر است در `config/smart-invoice.php` (مدل، timeout، آستانه اطمینان و سقف اختلاف مجاز).

## 3. اعتبارسنجی و تکمیل داده

`SmartInvoiceService` پس از دریافت خروجی خام Gemini مراحل زیر را انجام می‌دهد:

- نرمال‌سازی ساختار با استفاده از `InvoiceDataNormalizer`؛ این کلاس نگاشت کلید‌ها، تبدیل مقادیر متنی به عدد، و تشخیص نام فروشنده/خریدار را بر عهده دارد.
- محاسبه مجدد جمع اقلام، هزینه خدمات، حمل‌ونقل، تخفیف و پیش‌پرداخت. اگر مدل مقدار نهایی را پر نکرده باشد، سیستم آن را محاسبه می‌کند.
- مقایسه جمع اقلام با جمع سطر فاکتور و کنترل جمع کل (Subtotal + مالیات + … – تخفیف – پیش‌پرداخت). اختلاف بیش از آستانه تنظیم‌شده باعث علامت هشدار و کاهش ضریب اطمینان می‌شود.
- بازگرداندن آرایه‌ای استاندارد شامل `total_amount`, `tax_amount`, `line_items`, `analytics` و `raw_payload`. سپس `SmartInvoiceExtraction` این داده را به آبجکت strongly-typed تبدیل می‌کند.

## 4. ارتباط با رابط کاربری

- Livewire مجموعه `smartEntriesState` را برای هر ردیف نگه می‌دارد؛ وضعیت `success / loading / error`, مقدار اطمینان و خلاصه‌ای از فاکتور در این ساختار قرار می‌گیرد.
- در صورت وجود اختلاف، کاربر پیام هشدار به همراه مجموع محاسبه‌شده، مجموع استخراج‌شده و آستانه مجاز را مشاهده می‌کند.
- لیست اقلام (ردیف، شرح، تعداد، قیمت، تخفیف، مالیات) و خروجی‌های تحلیلی (currency note، validation، metadata) در زیر فرم نمایش داده می‌شوند.
- داده‌های ذخیره‌شده در `entries[n][meta][smart_invoice]` شامل نسخه خام پاسخ مدل نیز هست تا امکان ممیزی بعدی فراهم باشد.

## 5. تنظیمات

تمام تنظیمات از مسیر **تنظیمات → فاکتور هوشمند** مدیریت می‌شود:

| کلید | توضیح |
| --- | --- |
| `SMART_INVOICE_GEMINI_ENABLED` | فعال/غیرفعال کردن کل سامانه |
| `SMART_INVOICE_GEMINI_API_KEY` | کلید اختصاصی Google AI Studio |
| `SMART_INVOICE_GEMINI_MODEL` | نام مدل (پیش‌فرض `gemini-2.5-flash`) |
| `SMART_INVOICE_GEMINI_TIMEOUT` | حداکثر زمان انتظار (ثانیه) |
| `SMART_INVOICE_CONFIDENCE_THRESHOLD` | آستانه اطمینان برای نمایش هشدار |
| `SMART_INVOICE_VALIDATION_TOLERANCE` | سقف اختلاف قابل قبول بین جمع‌ها (ریال) |

مقادیر فوق در `config/smart-invoice.php` بارگذاری و در صورت ذخیره شدن از طریق پنل، به شکل داینامیک در `config('settings.*')` نگهداری می‌شوند.

## 6. خطا و لاگ

- خطاهای ارتباط با Gemini به صورت `SmartInvoiceException::requestFailed` بالا می‌آیند و پیام فارسی متناسب نمایش داده می‌شود.
- پاسخ‌های ناقص، JSON ناقص یا payload متنی در مسیر `storage/logs/smart-invoice` ذخیره می‌شود تا بتوان خروجی مدل را بررسی کرد.
- در صورت عدم وجود فایل ضمیمه یا غیر فعال بودن سرویس، پیام کاربرپسند با استفاده از فایل‌های ترجمه `resources/lang/*` نمایش داده می‌شود.

## 7. مسیر توسعه آینده

- آموزش prompt اختصاصی بر اساس مستندات فاکتورهای سازمان.
- افزودن فهرست خطاها و قوانین تشخیص تقلب (مثلا تشخیص تاریخ‌های خارج از دوره).
- یکپارچه‌سازی با ماژول گزارش‌گیری برای بررسی روند دقت (confidence) در بازه‌های زمانی مختلف.

با این تغییرات، کل چرخه «بارگذاری تصویر → استخراج → اعتبارسنجی → ثبت در فرم» تنها به یک سرویس PHP و API رسمی گوگل متکی است و نیازهای استقرار و نگهداری به حداقل ممکن رسیده است.
