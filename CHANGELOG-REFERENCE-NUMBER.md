# تغییرات: اصلاح سیستم تولید شماره مرجع (Reference Number)

## 📋 خلاصه تغییرات

شماره مرجع تراکنش‌ها حالا به صورت **مسلسل و پشت سر هم** تولید می‌شود و هم **ورود دستی** و هم **تولید خودکار** پشتیبانی می‌شود.

---

## 🐛 مشکلات قبلی

### 1️⃣ **مشکل در تولید شماره مرجع**
- ❌ فقط آخرین تراکنش (بر اساس ID) چک می‌شد
- ❌ بزرگترین شماره مرجع پیدا نمی‌شد
- ❌ شماره‌های دستی در محاسبه در نظر گرفته نمی‌شدند
- ❌ احتمال تولید شماره تکراری وجود داشت

### 2️⃣ **مشکل در ورود دستی**
- ❌ فیلد شماره مرجع `readonly` بود
- ❌ کاربر نمی‌توانست شماره را به صورت دستی وارد کند
- ❌ تنها حالت خودکار پشتیبانی می‌شد

### 3️⃣ **مشکل در زمان‌بندی تولید**
- ❌ شماره مرجع **بعد از ذخیره** تولید می‌شد
- ❌ در دیتابیس به درستی ذخیره نمی‌شد
- ❌ در لیست تراکنش‌ها نمایش داده نمی‌شد

---

## ✅ راه‌حل‌های اعمال شده

### 1️⃣ **بهبود الگوریتم تولید شماره**

#### قبل ❌:
```php
// فقط آخرین تراکنش را چک می‌کرد
$lastTransaction = PettyCashTransaction::where('ledger_id', $this->ledger->id)
    ->orderByDesc('id')
    ->value('reference_number');
```

#### بعد ✅:
```php
// همه تراکنش‌ها را چک می‌کند و بزرگترین شماره را پیدا می‌کند
$allTransactions = PettyCashTransaction::where('ledger_id', $this->ledger->id)
    ->whereNotNull('reference_number')
    ->pluck('reference_number');

foreach ($allTransactions as $refNumber) {
    if ($refNumber && preg_match('/-(\d+)(?:-|$)/', (string) $refNumber, $matches)) {
        $candidate = (int) $matches[1];
        if ($candidate > $lastNumber) {
            $lastNumber = $candidate;
        }
    }
}
```

### 2️⃣ **پشتیبانی از ورود دستی**

#### قبل ❌:
```html
<input
    type="text"
    wire:model.lazy="entries.{{ $index }}.reference_number"
    class="... bg-slate-100 ..."
    readonly
    title="این مقدار به صورت خودکار بر اساس سریال فاکتور تنظیم می‌شود."
/>
```

#### بعد ✅:
```html
<input
    type="text"
    wire:model.lazy="entries.{{ $index }}.reference_number"
    class="... (بدون bg و readonly)"
    placeholder="خودکار یا دستی..."
    title="می‌توانید شماره مرجع را به صورت دستی وارد کنید یا خالی بگذارید تا خودکار تولید شود."
/>
```

### 3️⃣ **اصلاح زمان‌بندی تولید**

#### قبل ❌:
```php
// شماره بعد از save تولید می‌شد
$transaction->save();
$this->syncEntryAttachments($transaction, ...);  // اینجا شماره تولید می‌شد!
```

#### بعد ✅:
```php
// شماره قبل از resolve entries تولید می‌شود
foreach ($this->entries as $index => $entry) {
    if ($this->entryLooksComplete($entry)) {
        $this->ensureSerialNumberAssigned($index);  // اینجا شماره تولید می‌شود
    }
}
$resolvedEntries = $this->resolveEntries();
```

### 4️⃣ **پشتیبانی از فرمت‌های مختلف**

```php
// فرمت‌های پشتیبانی شده:
// ✅ 001-0005        (کد شعبه - شماره)
// ✅ 001-0005-ABC    (کد شعبه - شماره - پسوند)
// ✅ 0005            (فقط شماره)
// ✅ INV-123         (هر متن - شماره)

if (preg_match('/-(\d+)(?:-|$)/', $refNumber, $matches)) {
    $candidate = (int) $matches[1];
} elseif (preg_match('/^(\d+)$/', $refNumber, $matches)) {
    $candidate = (int) $matches[1];
}
```

---

## 📝 فایل‌های تغییر یافته

### 1. **Backend - TransactionForm.php**
**فایل:** `app/Livewire/PettyCash/TransactionForm.php`

#### تغییرات:

**الف) متد `getNextSequentialNumber()` (خطوط 490-536)**
- ✅ بررسی **همه** تراکنش‌ها به جای فقط آخرین
- ✅ پیدا کردن **بزرگترین** شماره مرجع
- ✅ بررسی شماره‌های **دستی** در entries فعلی
- ✅ پشتیبانی از فرمت‌های مختلف

**ب) متد `save()` (خطوط 128-133)**
- ✅ تولید شماره **قبل از** `resolveEntries`
- ✅ اطمینان از اینکه شماره در دیتابیس ذخیره می‌شود

### 2. **Frontend - transaction-form.blade.php**
**فایل:** `resources/views/livewire/petty-cash/transaction-form.blade.php`

#### تغییرات (خطوط 260-289):
- ✅ حذف `readonly`
- ✅ حذف `bg-slate-100`
- ✅ اضافه کردن `placeholder`
- ✅ اضافه کردن icon indicator (✓ یا #)
- ✅ اضافه کردن توضیحات راهنما

---

## 🎯 نحوه کار

### حالت 1: تولید خودکار (فیلد خالی)

```
ورود کاربر:
┌──────────────────────────────┐
│ شماره مرجع:                  │
│ ┌──────────────────────────┐ │
│ │ (خالی)                   │ │
│ └──────────────────────────┘ │
└──────────────────────────────┘

خروجی سیستم:
┌──────────────────────────────┐
│ شماره مرجع: 001-0015 ✓       │
└──────────────────────────────┘

مثال: شعبه ۱، شماره ۱۵ ← 001-0015
```

### حالت 2: ورود دستی

```
ورود کاربر:
┌──────────────────────────────┐
│ شماره مرجع:                  │
│ ┌──────────────────────────┐ │
│ │ INV-2025-050             │ │
│ └──────────────────────────┘ │
└──────────────────────────────┘

خروجی سیستم:
┌──────────────────────────────┐
│ شماره مرجع: INV-2025-050 ✓   │
└──────────────────────────────┘

نکته: شماره ۵۰ استخراج می‌شود
```

### حالت 3: ترکیبی (دستی + خودکار)

```
تراکنش 1 (دستی):   001-0010 ✓
تراکنش 2 (خودکار):  001-0011 ✓  ← بزرگترین + 1
تراکنش 3 (دستی):   001-0025 ✓
تراکنش 4 (خودکار):  001-0026 ✓  ← بزرگترین + 1
```

---

## 📊 فرمت شماره مرجع

### ساختار پیش‌فرض:
```
[کد شعبه]-[شماره مسلسل]
   ↓           ↓
 001     -   0015
 3 رقم      4 رقم
```

### مثال‌ها:
| کد شعبه | شماره | خروجی |
|---------|-------|--------|
| 1 | 1 | `001-0001` |
| 1 | 15 | `001-0015` |
| 12 | 234 | `012-0234` |
| 123 | 5 | `123-0005` |

---

## 🧪 تست‌ها

### ✅ سناریو 1: تولید خودکار
```
1. دفتر جدید (بدون تراکنش)
   → اولین شماره: 001-0001 ✓

2. دفتر با 50 تراکنش
   → شماره بعدی: 001-0051 ✓
```

### ✅ سناریو 2: ورود دستی
```
1. وارد کردن: "INV-123"
   → ذخیره: INV-123 ✓
   → شماره بعدی خودکار: 001-0124 ✓

2. وارد کردن: "2025-500"
   → ذخیره: 2025-500 ✓
   → شماره بعدی خودکار: 001-0501 ✓
```

### ✅ سناریو 3: ترکیبی
```
1. تراکنش 1 (دستی): 001-0100
2. تراکنش 2 (خودکار): 001-0101 ✓
3. تراکنش 3 (دستی): 001-0200
4. تراکنش 4 (خودکار): 001-0201 ✓
```

### ✅ سناریو 4: شماره‌های پراکنده
```
تراکنش‌های موجود:
- 001-0005
- 001-0010
- 001-0050

شماره بعدی خودکار: 001-0051 ✓ (بزرگترین + 1)
```

---

## 🎨 بهبودهای UI/UX

### 1️⃣ **فیلد قابل ویرایش**
- ✅ کاربر می‌تواند تایپ کند
- ✅ placeholder راهنما: "خودکار یا دستی..."
- ✅ tooltip توضیحات کامل

### 2️⃣ **نشانگر بصری**
```
┌────────────────────────────┐
│ شماره مرجع (دستی/خودکار)  │
│ ┌──────────────────────┐   │
│ │ 001-0015         ✓   │   │  ← تیک سبز: شماره وارد شده
│ └──────────────────────┘   │
└────────────────────────────┘

┌────────────────────────────┐
│ شماره مرجع (دستی/خودکار)  │
│ ┌──────────────────────┐   │
│ │ (خالی)            #   │   │  ← # خاکستری: خودکار تولید می‌شود
│ └──────────────────────┘   │
└────────────────────────────┘
```

### 3️⃣ **پیام راهنما**
```
"در صورت خالی بودن، شماره به صورت خودکار و مسلسل تولید می‌شود"
```

---

## 🔄 مقایسه قبل و بعد

| ویژگی | قبل ❌ | بعد ✅ |
|-------|--------|--------|
| **تولید مسلسل** | ناقص | کامل |
| **ورود دستی** | غیرفعال | فعال |
| **بررسی همه تراکنش‌ها** | خیر | بله |
| **پیدا کردن بزرگترین شماره** | خیر | بله |
| **زمان تولید** | بعد از save | قبل از save |
| **ذخیره در DB** | احتمال خطا | تضمین شده |
| **فرمت‌های مختلف** | محدود | گسترده |
| **UI قابل ویرایش** | خیر | بله |

---

## 📦 سازگاری

- ✅ Laravel 12.x
- ✅ Livewire 3.x
- ✅ PHP 8.3+
- ✅ MariaDB / MySQL
- ✅ تراکنش‌های قدیمی حفظ می‌شوند

---

## 🐛 مسائل شناخته شده

هیچ مشکلی شناسایی نشده است.

---

## 🎯 کارهای آینده

- [ ] افزودن validation برای فرمت شماره مرجع
- [ ] نمایش هشدار برای شماره‌های تکراری
- [ ] امکان تعریف الگوی سفارشی برای شماره مرجع
- [ ] گزارش شماره‌های استفاده نشده (gaps)

---

## 📞 پشتیبانی

در صورت بروز مشکل:
- 📧 Email: support@zdr.ir
- 💬 GitHub Issues: https://github.com/separkala-ui/zdr/issues

---

**نسخه:** 2.4.0  
**تاریخ:** 26 آبان 1404  
**وضعیت:** ✅ تکمیل شده و آماده استفاده

